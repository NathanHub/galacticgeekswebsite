<!DOCTYPE html>


<!-- Hey there curious monkey ;)
Copyright 2016 by Hugo Peters -->

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:fb="http://ogp.me/ns/fb#"
      lang="en">

<!-- Mirrored from hugo.fyi/projects/reverse-engineering-b2s by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 20 Aug 2021 04:18:48 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	 <meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user_scalable=0'>
	<meta name="author" content="Hugo Peters">
	<meta name="mobile-web-app-capable" content="yes">

	<!-- BEGIN SEOmatic rendered SEO Meta -->

<title>Hugo.fyi | Hugo Peters - Game Programming &amp; Design Portfolio</title>

<!-- Standard SEO -->

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="referrer" content="always" />
<meta name="robots" content="all" />
<meta name="keywords" content="programming, portfolio, game, development, game development, hugo peters, c++, c#, gamedev, game design" />
<meta name="description" content="Game programming, development &amp; design portfolio of Hugo Peters. Junior Game Programmer at Ubisoft." />
<meta name="generator" content="SEOmatic" />
<link rel="canonical" href="reverse-engineering-b2s.html" />

<!-- Dublin Core basic info -->

<meta name="dcterms.Identifier" content="reverse-engineering-b2s.html" />
<meta name="dcterms.Format" content="text/html" />
<meta name="dcterms.Relation" content="Hugo Peters - Game Programming &amp; Design Portfolio" />
<meta name="dcterms.Language" content="en" />
<meta name="dcterms.Publisher" content="Hugo Peters - Game Programming &amp; Design Portfolio" />
<meta name="dcterms.Type" content="text/html" />
<meta name="dcterms.Coverage" content="../index.html" />
<meta name="dcterms.Rights" content="Copyright &copy;2021 Hugo Peters." />
<meta name="dcterms.Title" content="Hugo.fyi" />
<meta name="dcterms.Subject" content="programming, portfolio, game, development, game development, hugo peters, c++, c#, gamedev, game design" />
<meta name="dcterms.Contributor" content="Hugo Peters - Game Programming &amp; Design Portfolio" />
<meta name="dcterms.Date" content="2021-08-19" />
<meta name="dcterms.Description" content="Game programming, development &amp; design portfolio of Hugo Peters. Junior Game Programmer at Ubisoft." />

<!-- Facebook OpenGraph -->

<meta property="og:type" content="website" />
<meta property="og:locale" content="en_us" />
<meta property="og:url" content="reverse-engineering-b2s.html" />
<meta property="og:title" content="Hugo.fyi | Hugo Peters - Game Programming &amp; Design Portfolio" />
<meta property="og:description" content="Game programming, development &amp; design portfolio of Hugo Peters.  Junior Game Programmer at Ubisoft." />
<meta property="og:image" content="../assets/SiteMetaBg.jpg" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="512" />
<meta property="og:image:height" content="276" />
<meta property="og:site_name" content="Hugo Peters - Game Programming &amp; Design Portfolio" />
<meta property="og:see_also" content="https://twitter.com/HugoPeters96" />
<meta property="og:see_also" content="https://www.linkedin.com/in/hugo-peters-8a695184" />

<!-- Twitter Card -->

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@HugoPeters96" />
<meta name="twitter:creator" content="@HugoPeters96" />
<meta name="twitter:title" content="Hugo.fyi | Hugo Peters - Game Programming &amp; Design Portfolio" />
<meta name="twitter:description" content="Game programming, development &amp; design portfolio of Hugo Peters.  Junior Game Programmer at Ubisoft." />
<meta name="twitter:image" content="../assets/SiteMetaBg.jpg" />


<!-- Humans.txt authorship http://humanstxt.org -->

<link type="text/plain" rel="author" href="../humans.txt" />

<!-- Domain verification -->


<!-- Identity -->

<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "Hugo Peters",
    "url": "http://hugo.fyi/",
    "sameAs": ["https://twitter.com/HugoPeters96","https://www.linkedin.com/in/hugo-peters-8a695184"],
    "gender": "Male" 
}
</script>

<!-- WebSite -->

<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Hugo Peters - Game Programming &amp; Design Portfolio",
    "description": "Game programming, development &amp; design portfolio of Hugo Peters.  Junior Game Programmer at Ubisoft.",
    "url": "http://hugo.fyi/",
    "image": "http://hugo.fyi/assets/SiteMetaBg.jpg",
    "sameAs": ["https://twitter.com/HugoPeters96","https://www.linkedin.com/in/hugo-peters-8a695184"],
    "copyrightHolder": {
        "@type": "Person",
        "name": "Hugo Peters",
        "url": "http://hugo.fyi/",
        "sameAs": ["https://twitter.com/HugoPeters96","https://www.linkedin.com/in/hugo-peters-8a695184"],
        "gender": "Male" 
    },
    "author": {
        "@type": "Person",
        "name": "Hugo Peters",
        "url": "http://hugo.fyi/",
        "sameAs": ["https://twitter.com/HugoPeters96","https://www.linkedin.com/in/hugo-peters-8a695184"],
        "gender": "Male" 
    },
    "creator": {
        "@type": "Organization" 
    } 
}
</script>

<!-- Place -->



<!-- Main Entity of Page -->



<!-- Breadcrumbs -->

<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": "1",
            "item": {
                "@id": "http://hugo.fyi/",
                "name": "Welcome to Hugo.fyi!" 
            } 
        },
        {
            "@type": "ListItem",
            "position": "2",
            "item": {
                "@id": "http://hugo.fyi/projects/reverse-engineering-b2s",
                "name": "Reverse Engineering Beyond: Two Souls" 
            } 
        }
    ] 
}
</script>

<!-- Google Tag Manager -->


<!-- Google Analytics -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89570321-1', 'auto', {allowLinker: true});
  ga('require', 'displayfeatures');
  ga('require', 'linkid');
  ga('require', 'linker');
  ga('send', 'pageview');
</script>
<!-- END SEOmatic rendered SEO Meta -->
	
	<title>Hugo Peters - Game Programming &amp; Design Portfolio</title>
	
	<!-- Import stylesheets -->
														
	<!-- Import fonts -->
	<link href="https://fonts.googleapis.com/css?family=Arvo" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">

	<!-- Global script -->
	<script type="text/javascript">
		var _siteUrl = "../index.html";
		var _livePreview = false;

			</script>
	
	<!-- Import scripts -->
																
	<script src="../../cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

	<!-- Begin Smartlook -->
	<script type="text/javascript">
	    window.smartlook||(function(d) {
	    var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];
	    var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';
	    c.charset='utf-8';c.src='../../rec.smartlook.com/recorder.js';h.appendChild(c);
	    })(document);
	    smartlook('init', 'aef82bd583b6b9fdad3e293e43a38f7c89a3ba4c');
	</script>
	<!-- End Smartlook -->

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
  <link rel="stylesheet" type="text/css" href="../css/bootstrap.css"/>
<link rel="stylesheet" type="text/css" href="../css/BootstrapXL.css"/>
<link rel="stylesheet" type="text/css" href="../css/spinner.css"/>
<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/jquery.fullpage.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/hamburgers.css"/>
<link rel="stylesheet" type="text/css" href="../css/flickity.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/lity.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/tomorrow-night.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/photoswipe.css"/>
<link rel="stylesheet" type="text/css" href="../css/photoswipe-default-skin/default-skin.css"/>
<link rel="stylesheet" type="text/css" href="../css/plyr.css"/>
<link rel="stylesheet" type="text/css" href="../less/common2.css"/></head>
  <body>
  	<div id="page-container">
  		<div id="background-frame">
  				  		</div>

		<!-- PRELOADER -->
		<div id="preloader-frame">
			<div id="preloader-loader">
				<div class="spinner"></div>
			</div>
		</div>
		<!-- End of PRELOADER -->

		<div id="page">
							<div id="pp-container">
	<!-- <div class="pp-bg"></div> -->
	<div class="container pp-contents-container">
		<div class="row">
			<div class="col-xs-12 col-sm-12 col-md-12"">
				<!-- PROJECT TITLE -->
				<div class="pp-title-container">
					<div class="pp-title">
						<span>Reverse Engineering Beyond: Two Souls</span>
					</div>
				</div>
				<!-- End of PROJECT TITLE -->

				<!-- PROJECT FACTS -->
				
				<div class="pp-facts-container">
					<table style="margin: auto;">
																																																												<tr>
							    	<td class="pp-facts-cell"><strong>Software Used</strong></td>
							    	<td class="pp-facts-cell">Visual Studio, 010 Editor (hex viewer), a text editor and a calculator</td>
						    	</tr>
					    																						<tr>
							    	<td class="pp-facts-cell"><strong>Languages Used</strong></td>
							    	<td class="pp-facts-cell">C#</td>
						    	</tr>
					    																									</table>
				</div>
				<!-- End of PROJECT FACTS -->

				<!-- PROJECT DESCRIPTION -->
				<div class="pp-contents">

					

									
                 			    	    	<p><em>Disclaimer: This project was entirely for <u>educational purposes only</u>. My intention was never to (nor will I ever) release any copyrighted assets. Please note that I'm leaving out </em><em>a lot of information with the reason of being respectful to Quantic Dream and preventing others from copying my work.</em></p>

<p><p><em><strong>Quantic Dream is aware of this project</strong></em></p></p>

	    	    	        		    	    		    	    	<p><img src="../assets/projects/b2s/B2S_Front.png" alt="B2S_Front.png#asset:314" /><br /></p>

<p><p>After I played Beyond I felt like the game left quite an impact on me emotionally, I wanted to learn more about the game, its development, and how such a content-heavy technological marvel works under the hood. Given the game's dynamic and data-driven nature I felt like there was a lot to explore and learn.<br /></p>
<p>This turned into a sort of obsession of overcoming each challenge that was put in front of me to understand how each system in the game's engine works. My main tools were Visual Studio and a Hex editor, and I would often use my debug PS3 to test hypotheses I had about how the game works internally. I would for instance stream the game over my local network to the PS3, and then unplug the network cable to see what was being streamed and what was buffered in advance (this is how I found out body and facial animation was separated).</p></p>

	    	    	        		    	    	

                    											<div class="accordion">
							<i class="fa fa-info" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Understanding the top-level structure</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>I opened some of the game's data files (that are on the disc) in a Hex viewer. There are really only a few large files on the disc prefixed "BigFile", so I assumed these contained some form of concatenated file entries. Most of these files use a form of proprietary compression using Zlib, but some smaller entries go uncompressed. </p>

<p><p>A typical entry within the game data looks like this:</p>
<p><img src="../assets/projects/b2s/B2S_01_01.png" alt="B2S_01_01.png#asset:283" /><br /></p><p>The entry above begins at 0x800. These entries are unnamed, but seem to be sort of grouped based on their context, or date of creation by the developer.</p><p>At this point I made an extractor that scanned these files and extracted all the entries, but I didn't find out yet how the game would actually index all of these entries.</p><p><br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            				
                    															<div class="accordion">
							<i class="fa fa-info" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Indexing the BigFile entries</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>Each of the game's BigFile "groups" had their own &lt;GroupName&gt;.sdat file. After decrypting them, the header looks like this:</p>

<p><p><img src="../assets/projects/b2s/BS2_02_01.png" alt="BS2_02_01.png#asset:284" /><br /></p>
<p>This data defines a table of groups of entries, each with their own type, an offset within the file where the entry definitions start and how many there are. One entry definition told me in which BigFile (within the group) it's located, the offset, size, and more. They look like this (one entry marked in red):</p>
<p><img src="../assets/projects/b2s/B2S_02_02.png" alt="B2S_02_02.png#asset:285" /><br /></p><h2>InfraTool</h2><p>With these new findings I wrote a tool that would allow me to quickly look through all these entries: InfraTool!</p><p><img src="../assets/projects/b2s/B2S_02_03.png" alt="B2S_02_03.png#asset:288" /><br /></p><p>I also implemented a Hex viewer inside this tool, immensely improving my workflow of inspecting different data types:</p><p><img src="../assets/projects/b2s/BS2_02_04.png" alt="BS2_02_04.png#asset:289" /><br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-info" aria-hidden="true"></i>
							<span style="margin-left: 5px;">The Type/Id system</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>At this point I had no clue how these entries actually relate to each other, how the game knows what content to expect, etc.</p>

<p><h2>Finding the "dynamic" Lua initialization functions</h2>
<p>I performed a RAM dump on my PS3 to see if the game would do any post-loading modifications to the data, but instead of finding anything about that, I noticed Lua strings that seemed to initialize object-creation functions for many types.</p>
<p>I wrote a tool that searches for these types of strings, and from that output I wrote a tool to generate an enum of all the strings.<br />The end result has over 500 types, including:</p>
<pre>
VARIABLE&#95;CONNECTOR&#95;INSTANCE = 47,
VARIABLE&#95;CONNECTOR&#95;CONTROLLER = 48,
DATA&#95;CONTAINER&#95;PATCH = 49,
VARIABLE&#95;CONTAINER = 50,
VARIABLE&#95;CONNECTOR&#95;BANK_INSTANCE = 51,
LOD&#95;GLOBALS = 53,
TIMER = 1001,
SOUND&#95;OFFSET = 1009,
SOUND&#95;DATA = 1010,
LOCALIZATION&#95;CONTAINER = 1016,
DEVICE&#95;OBSERVER&#95;CONFIG = 1020,
</pre>
<h2>Connecting it all with the game data</h2>
<p>I quickly realized these types map to many of the unknown values I had been seeing, as there seemed to be a lot of constants within the game's data. Taking the example from a game data entry from earlier:</p>
<p><img src="../assets/projects/b2s/B2S_03_02.png" alt="B2S_03_02.png#asset:293" /><br /></p>
<p>The four red marked identifiers are all types that can be mapped back to the enum:</p>
<pre>
LOADING&#95;ZONE = 2513 (0x869),
SCENE = 4011 (0xFAB),
AREA = 4000 (0xFA0),
</pre>
<p>The same concept applies to the .sdat files which index the top-level file entries.</p>
<p>Suddenly, I was able to get a lot better insight the types of content within the game, as each entry now had a readable type associated with it!</p>
<p><img src="../assets/projects/b2s/B2S_03_03_2.png" alt="B2S_03_03_2.png#asset:295" /><br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-code" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Lua engine binding &amp; generated scripts</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>Lua is the game's main form of communicating with the game data. Quantic Dream uses a visual node graph editor to allow designers to quickly script gameplay behavior (and more), and from these graphs Lua code is generated and pre-compiled.</p>

<p><p>The pre-compilation causes the outputting bytecode to be incompatible with PCs, as PS3 is big-endian and Intel based processors little-endian. For this reason I was required to also develop a big- to little-endian converter for the Lua bytecode chunks.</p>
<p>This framework is very much event driven, with many custom functionalities to ease this process (MESSAGE&#95;LAUNCHER &amp; MESSAGE&#95;DISPATCHER, Dynamic Communicators, Communicator Actions to name a few).</p>
<p>Note that pretty much <strong>all</strong> functions are custom to Quantic's engine (New, NewPlaced, NewOS), not to mention, each engine class has a ton of functions, with (to me) unknown parameters that I had to investigate individually.</p>
<p>I won't go into detail on how the Lua scripts reference the game data assets.<br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-info" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Navigating the game structure</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>Now I could find entries within the game data given the Type/Id values within other file entries, so I was able to extrapolate the hierarchy of the game data pretty easily.</p>

<p><p>I won't go into detail too much on how the game hierarchy works, but in short there's a single GAME_MANAGER entry within the data, that links to a STORYBOARD entry, that links to multiple scenes, which then reference scripts, audio, models, etc.</p>
<h2>InfraViewer</h2>
<p>The next step was a tool that would dynamically search each scene in the game data to create an understandable view of the structure so I could investigate the actual data of all this content. The Lua scripts play a big role in this, as they make the actual connections to the game data, and perform the logic for the game to run. By decompiling and scanning the scripts for these special types of references, I could construct a very consistent way of navigating scene structures:</p>
<p><img src="../assets/projects/b2s/B2S_04_01_2.png" alt="B2S_04_01_2.png#asset:299" /><br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-info" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Sequences, movies, and timelines</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>Sequences are what make up all of the game's realtime cinematics, where a movie is a single timeline of events (dialog, sounds, camera shots, animations, script events and more). The movies can link to each other, play in cycle, jump to another based on a dialog option, etc. All of the movies combined is the <em>sequence</em>.</p>

<p><p>If you'd take one sequence and put it in a flowgraph, it looks like this:</p>
<p><img src="../assets/B2S_Sequences_01.png" alt="B2S_Sequences_01.png#asset:312" /></p>
<p>The green node is the start of the sequence, each blue node a movie, each purple node a different condition for jumping to another movie (script condition, coded condition, etc), and each orange node is a comparison to the condition.</p>
<p>Movies have their own script events, and they can delay a function call's finish events until the movie is finished.<br />The whole sequencing system is pretty much at the core of the engine, it took a lot of time to figure out all of the dependencies, and reading the data itself was also a pain because of the many different types of data it can handle.</p>
<p>Dissecting a sequence, I could make an overview of the different sequence elements:</p>
<p><img src="../assets/projects/b2s/B2S_Sequences_02.png" alt="B2S_Sequences_02.png#asset:321" /><br /></p>
<p>For me to figure out how this all is structured, it involved a lot of trial and error on many different sequences, and about 5 rewrites of the sequence player...<br /></p>
<p>I'll explain how a few of these elements work:</p>
<h2>MOVIE&#95;PLAY&#95;DIALOG&#95;ACTION</h2>
<p>All dialog (and facial animation) within the game is done through this element. It links to audio data, localization (subtitles), target character, sets start / end times, and a lot more.</p>
<p>Dissecting it in the debugger of my implementation:</p>
<p><img src="../assets/projects/b2s/B2S_Localiz_01.png" alt="B2S_Localiz_01.png#asset:322" /><br /></p>
<h2>PLAY&#95;SCRIPT&#95;TOP</h2>
<p>This allows script events to be executed while a movie is playing. It is mainly used to play music (that should continue after a movie has ended), FX actions, force a certain LOD level on characters, etc. </p>
<p>The action itself is quite simple, only providing a string of the event identifier. It is executed on multiple instances however. It executes on the calling instance of the sequence player, but also on SCRIPT_BANK's script of the movie and sequence. My implementation looks like this:</p></p>

	    	    	        		    	    		    	    	    		    		<pre class="prettyprint linenums">MovieCtx.Controller.SequencePlayController.Events["OnScriptTop"].Call(MovieCtx.Controller.InstanceContext, ScriptTopValue, 0, MovieCtx.Controller.SequencePlayController.LuaPtr);
MovieCtx.Controller.Sequence.Events["OnScriptTopSequence"].Call(MovieCtx.Controller.InstanceContext, ScriptTopValue, 0);
MovieCtx.Movie.Events["OnScriptTop"].Call(MovieCtx.Controller.InstanceContext, ScriptTopValue, 0);</pre>
	    		    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-question" aria-hidden="true"></i>
							<span style="margin-left: 5px;">User Action Conditions</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p><img src="../assets/projects/b2s/B2S_UAC_01.png" alt="B2S_UAC_01.png#asset:315" /></p>

<p><p>Once I had sequences running I quickly started running into these timeline events. There are a few "interact-able" events, like MOVIE&#95;DIALOG&#95;GROUP&#95;CONDITION and MOVIE&#95;USER&#95;ACTION&#95;CONDITION.</p>
<p>MOVIE&#95;DIALOG&#95;GROUP&#95;CONDITION is a group of dialog options that the player can choose from. The binary definition of this element looks like this when reversed:</p></p>

	    	    	        		    	    		    	    	    		    		<pre class="prettyprint linenums">public int ElementCRC;
public int TypeStyle;
public int DisplayStyle;
public int AnimationType;
public int AnimationConfusion;
public float TextSizeFactor;
public float _3DSizeFactorX;
public float _3DSizeFactorY;
public float _3DSizeFactorZ;
public bool AnimationLookAt;
public ComBinPtr DialogCharacter;
public ComBinPtr DialogObject;
public IntExtCom DialogAddress;
public Vector3 DialogGlobalOffset;
public Vector3 DialogLocalOffset;
public string DialogOffsetBoneName;
public int DialogViewportID;
public bool ApplyTextSizeFactorToRadius;
public bool ThoughtsDisplayData; // unused?? hr left over..
public float DIALOGS_1_rXStatic;
public float DIALOGS_1_rXDiff;
public float DIALOGS_1_rYStatic;
public float DIALOGS_1_rYDiff;
public float DIALOGS_1_rZStatic;
public float DIALOGS_1_rZDiff;
public bool DIALOGS_1_bUsePitch;
public IntExtCom SPECIFIC_ADDRESSES_Address1;
public IntExtCom SPECIFIC_ADDRESSES_Address2;
public IntExtCom SPECIFIC_ADDRESSES_Address3;
public IntExtCom SPECIFIC_ADDRESSES_Address4;
public float DIALOGS_2D_OffsetX1;
public float DIALOGS_2D_OffsetY1;
public float DIALOGS_2D_OffsetScale1;
public float DIALOGS_2D_OffsetX2;
public float DIALOGS_2D_OffsetY2;
public float DIALOGS_2D_OffsetScale2;
public float DIALOGS_2D_OffsetX3;
public float DIALOGS_2D_OffsetY3;
public float DIALOGS_2D_OffsetScale3;
public float DIALOGS_2D_OffsetX4;
public float DIALOGS_2D_OffsetY4;
public float DIALOGS_2D_OffsetScale4;
public float DialogNoiseAmplificationFactor;</pre>
	    		    	        		    	    		    	    	<p><p>I was able to reconstruct the variable names pretty easily, because most of this data is actually defined in the SINT_SEC element (a collection of initialization parameters it seems), and the names match up:</p><p><img src="../assets/projects/b2s/B2S_UAC_02.png" alt="B2S_UAC_02.png#asset:319" /><br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-camera" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Camera shots, keyframes, and effects</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p><p>Beyond: Two Souls features very cinematic camera shots, and for this the data related to them is quite elaborate. Luckily for me, the options are named and categorized!</p><p><img src="../assets/projects/b2s/B2S_Camera_01.png" alt="B2S_Camera_01.png#asset:327" /><br /></p><p>This made it quite easy to find the correct structure of parsing the properties:</p><p><img src="../assets/projects/b2s/B2S_Camera_02.png" alt="B2S_Camera_02.png#asset:328" /><br /></p><p>All of the extra effects (smoothing, shake, etc) are applied at runtime.</p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-music" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Audio &amp; Partition Streaming</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>There are two different methods of loading in audio</p>

<p><ul><li>Internal: Mainly for short audio such as footsteps and other effects.</li><li>Streamed: For anything longer than a few seconds, such as music, ambiance, dialog.</li></ul><p>Audio was one of the first things I figured out, as most of it goes without top-level compression within the game data:</p>
<p><img src="../assets/projects/b2s/B2S_Audio_01.png" alt="B2S_Audio_01.png#asset:330" /><br /></p>
<p>When I noticed the LAME3.97 tag within the data it was pretty clear to me that this is just plain MP3-encoded data.<br />All of this "external" data is streamed, and the audio is split in 1-second chunks.<br /></p>
<p>If the audio is for dialog, I noticed some more data before all of the audio chunks:</p>
<p><img src="../assets/projects/b2s/B2S_Audio_02.png" alt="B2S_Audio_02.png#asset:331" /><br /></p>
<p>I later found out "SKA" stands for <strong>"Streamable Keyframe Animation"</strong> - so this data is meant for facial animation and also loaded per second.</p>
<p>To load this data, I needed a table of offsets that would give me the positions of all these chunks, but it wasn't in the audio data... I actually found it as a separate entry within the files that would <em>reference </em>the external audio data...</p>
<p><img src="../assets/projects/b2s/B2S_Audio_03.png" alt="B2S_Audio_03.png#asset:332" /></p>
<p>For my implementation I used <a href="https://www.un4seen.com/bass.html" target="_blank">BASS</a>, as it supported this type of streaming quite nicely. On a high level, the implementation uses a ring buffer where new audio is streamed in to. Another thing to take into account is that most of the audio is multi-channel (surround sound I presume), so when I started loading the data I quickly found out that each second was actually 3 seconds but each one sounded different. Sometimes the different channels would have other ambiance effects, but it's not that heavily used within the game.</p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-font" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Localization &amp; Subtitles</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>When I started this project, one of the main questions I asked myself was "I wonder how subtitles are synced with this amount of data". Before we look into subtitles specifically, let's check on LOCALIZATION_CONTAINER first. The binary component for this text container looks like this:</p>

<p><p><img src="../assets/projects/b2s/B2S_Localiz_02.png" alt="B2S_Localiz_02.png#asset:335" /></p>
<p><em>Fun Fact: The dialog above was actually part of Beyond's first E3 unveiling, but goes unused in the final game!</em></p>
<p>Before the text data, there is of course a table of offsets into the string table, as well as references to the audio data belonging to the section. All localization data is... localized, so all sections are written in many different languages.<br /></p>
<p>After parsing the text we get this:</p>
<p><img src="../assets/projects/b2s/B2S_Localiz_03.png" alt="B2S_Localiz_03.png#asset:337" /><br /></p>
<p>This is actually <em>not</em> how the data appears in binary. When you read the data, the raw text you get looks like this:</p>
<pre>
{S}{&#42;1}Ma'am…{&#42;2}Ma'am?{&#42;3}Do you hear me?{&#42;4}Do you understand me...?{&#42;5}Do you speak English?{&#42;6}I...
{&#42;7}brought you that cup of coffee…{&#42;TC:31620|32690}Okay...
{&#42;8}I found you by the side of the road, in the middle of nowhere...{&#42;9}Was there an accident?
{&#42;10}Did someone try to hurt you...?{&#42;11}Look, I wanna help you{&#42;12}but… ya gotta give me something...{&#42;13}anything.
{&#42;14}How about a name?{&#42;15}Someone I could contact?{&#42;16}You must have family...{&#42;17}friends...
{&#42;18}someone who could tell me who you are?{&#42;19}You don't talk much, do you?
{&#42;20}Well, if you don't help me, I can't help you...{&#42;22}We're getting nowhere...{&#42;23}Is that a scar?
{&#42;24}Is that recent...?{&#42;25}Uhm…{&#42;26}I'm gonna go to my office{&#42;27}check the Missing Persons list…
{&#42;28}You stay here, I'll be right back.</pre>
<p>Each piece of localization (individual subtitles) have a tag before the text. This can be different things: {&#42;3} would indicate the following text is mapped to 'index 2' in the list of subtitles offsets for matching audio<em>. </em>The {&#42;TC:31620|32690} specifies a custom offset in the audio for where to place the subtitle.</p>
<p>This list of subtitle offsets <em>is </em>defined after the audio data, which makes it weird that the table for the audio chunks themselves isn't (see <em>Audio &amp; Partition Streaming</em>).</p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-map" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Navigation Meshes</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p><img src="../assets/projects/b2s/B2S_Navmesh_01.png" alt="B2S_Navmesh_01.png#asset:338" /></p>

<p><p>I ended up not really using this at all though, but it was still interesting to figure out!</p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-male" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Models and Mesh Data</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>Probably the thing people ask me most is to release the character models... </p>

<p><p><img src="../assets/projects/b2s/B2S_Models_01.png" alt="B2S_Models_01.png#asset:340" /><br /></p>
<p>I won't go into detail on how the mesh formats work, how they are located, or how the scene graph works.</p>
<p>The models in Beyond are quite complex, especially the scene graph - which took me many iterations before I figured things out properly.</p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-male" aria-hidden="true"></i>
							<span style="margin-left: 5px;">Skeleton, Bone Modifiers, Skinning</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p><img src="../assets/projects/b2s/B2S_Skinning_01.png" alt="B2S_Skinning_01.png#asset:342" /></p>

<p><p><img src="../assets/projects/b2s/B2S_Skinning_02.png" alt="B2S_Skinning_02.png#asset:344" /><br /></p><p><img src="../assets/projects/b2s/B2S_Skinning_03.png" alt="B2S_Skinning_03.png#asset:351" /><br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            															<div class="accordion">
							<i class="fa fa-hand-pointer-o" aria-hidden="true"></i>
							<span style="margin-left: 5px;">User Interface (MenusMaster)</span>
							<div class="accordion-icon">
								<i class="fa fa-times" aria-hidden="true"></i>
							</div>
						</div>
						<div class="accordion-inner">
                 	
                 			    	    	<p>Beyond uses the middleware "Menus Master" (which seems to be dead now), which I reversed for about 80%. There are still many inconsistencies with the retail version, but most of the UIs show up decently!</p>

<p><p><img src="../assets/projects/b2s/B2S_UI_01.jpg" alt="B2S_UI_01.jpg#asset:345" /><br /></p>
<p>The data is structured quite cleverly, mostly using static pointers within its own data, so this was a lot of fun to implement in C# :)</p>
<p>A list of resource type strings is populated, and each resource indexes into this list. After that I can compare it to the whole set and then create instances accordingly:</p></p>

	    	    	        		    	    		    	    	    		    		<pre class="prettyprint linenums">public class MenusMasterResource : MMOffsetData
{
    public MMPointer BasePointer;
    public long Offset;
    public uint ValueType;
    public MMOffsetData Value;

    protected override void Read(BinaryReader handle)
    {
        Offset = handle.BaseStream.Position;

        ValueType = handle.ReadUInt32BE();
        var strValueType = this.Root.BigTable.Data_3_ResourceTypes[ValueType];

        switch (strValueType)
        {
            case "MmDk::CMenu": Value = new CMenu(); break;
            case "MmDk::CExpression": Value = new CExpression(); break;
            case "MmDk::CExpressionItemIf": Value = new CExpressionItemIf(); break;
            case "MmDk::CExpressionItemStd": Value = new CExpressionItemStd(); break;
            case "MmDk::CExpressionItemContainer": Value = new CExpressionItemContainer(); break;
            case "MmDk::CObjectList::CNode": Value = new CObjectList.CNode(); break;
            case "MmDk::CAnimEnvelopeFloat": Value = new CAnimEnvelopeFloat(); break;
            case "MmDk::CAnimEnvelopeInteger": Value = new CAnimEnvelopeInteger(); break;
            case "MmDk::CKeyFloat": Value = new CKeyFloat(); break;
            case "MmDk::CAreaRectangle": Value = new CAreaRectangle(); break;
            case "MmDk::CButton": Value = new CButton(); break;
            case "MmDk::CbuttonPage": Value = new CbuttonPage(); break;
            case "MmDk::CMatrix2D": Value = new CMatrix2D(); break;
            case "MmDk::CSizeBase2D<1>": Value = new CSizeBase2D_1(); break;
            case "MmDk::CSizeBase2D<0>": Value = new CSizeBase2D_0(); break; // combine?
            case "MmDk::CObjectText": Value = new CObjectText(); break;
            case "MmDk::CbuttonParamCommand": Value = new CbuttonParamCommand(); break;
            case "MmDk::CLocalize": Value = new CLocalize(); break;
            case "MmDk::CObjectSprite": Value = new CObjectSprite(); break;
            case "MmDk::CResSprite": Value = new CResSprite(); break;
            case "MmDk::CResStillImage": Value = new CResStillImage(); break;
            case "MmDk::CResText": Value = new CResText(); break;
            case "MmDk::CObjectEmpty2D": Value = new CObjectEmpty2D(); break;
            case "MmDk::IResNode": Value = new IResNode(); break;
            default:
                {
                    throw new Exception("Unknown Menus Master type: " + strValueType);
                }
        }

        Value.ReadTypeInAdvance = false;
        Value.BeginRead(handle, this.Root);
    }

    public override string ToString()
    {
        return this.Root.BigTable.Data_3_ResourceTypes[ValueType] + ((Value == null) ? " [n/a]" : "  [ " + Value.ToString() + " ]");
    }
}</pre>
	    		    	        		    	    		    	    	<p>To give you an idea of the hierarchy, this is some of the install screen's output:</p>

<p><p><img src="../assets/projects/b2s/B2S_UI_02.png" alt="B2S_UI_02.png#asset:346" /><br /></p>
<p><br /></p>
<p>I could even get Beyond's loading screen to show up (the background is actually a video played using the Lua framework and is not part of the GUI):</p>
<p><img src="../assets/projects/b2s/B2S_UI_03.png" alt="B2S_UI_03.png#asset:347" /><br /></p></p>

	    	    	        		    	    	

                    
                    		            	</div>	
		            				
				</div>
			</div>
		</div>
	</div>
	<!-- End of PROJECT DESCRIPTION -->
</div>

				<div id="footer" class="section--small section" style="background-color: #525252">
					<div class="section-content" style="text-align: center; padding-top: 10px; padding-bottom: 10px; margin-top: 40px;">
						<span class="text">Copyright © 2021 by Hugo Peters | All images, logos and names are used with permission</span>
											</div>
				</div>
			
					</div>
  	</div>

  		  	<!-- MENU BAR -->
		<div id="menubar-container">
			<!-- MENU BAR BG -->
			<div id="menubar-bg"></div>
			<!-- End of MENU BAR BG -->

			<!-- MENU BAR CONTENT -->
			<div class="container-fluid">
				<div class="row-fluid">
					<!-- MENU BAR TITLE -->
					<div class="col-xs-8 col-sm-4 col-md-3 col-lg-3 col-xl-2">
						<div id="menubar-title" class="noselect">
							<span>Hugo Peters</span>
						</div>
					</div>
					<!-- End of MENU BAR TITLE -->

					<!-- MENU BAR ITEMS -->
					<div class="col-sm-6 col-md-9 col-lg-9 col-xl-10">
						<div id="menubar-items-container">
							<div class="menubar-item" data-target-element="#about">
								<div class="noselect menubar-item-text">
									<span><i class="fa fa-lightbulb-o" aria-hidden="true"></i>   ABOUT</span>
								</div>
							</div>
							<div class="menubar-item" data-target-element="#professional-projects">
								<div class="noselect menubar-item-text">
									<span><i class="fa fa-users" aria-hidden="true"></i>   PROFESSIONAL PROJECTS</span>
								</div>
							</div>
							<div class="menubar-item" data-target-element="#personal-work">
								<div class="noselect menubar-item-text">
									<span><i class="fa fa-heart" aria-hidden="true"></i>   PERSONAL WORK</span>
								</div>
							</div>
								<a href="../HugoPetersCV.pdf" onclick="trackResume();return true;" style="border: none; text-decoration: none;" target="_blank" class="menubar-item">
									<span class="noselect menubar-item-text"><i class="fa fa-file-text" aria-hidden="true"></i>   RÉSUMÉ</span>
								</a>
							</a>
							<div class="menubar-item" data-target-element="#contact">
								<div class="noselect menubar-item-text">
									<span><i class="fa fa-comments" aria-hidden="true"></i>   CONTACT</span>
								</div>
							</div>
							<div class="twitter-follow-button-wrap" style="display: inline-block; margin-top: 13px; margin-left: 5px; position: absolute;">
								<a href="https://twitter.com/HugoPeters96?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow Me</a><script async src="../../platform.twitter.com/widgets.js" charset="utf-8"></script>
							</div>
						</div>
					</div>
					<!-- End of MENU BAR ITEMS -->

					<!-- MENU BAR HAMBURGER -->
					<div class="col-xs-4 col-sm-2">
						<div id="menubar-hamburger-icon" class="hamburger hamburger--spin" style="color: white;">
						  <div class="hamburger-box">
							<div class="hamburger-inner"></div>
						  </div>
						</div>
					</div>				
					<!-- End of MENU BAR HAMBURGER -->
				</div>
			</div>
			<!-- End of MENU BAR CONTENT -->
		  </div>
		<!-- End of MENU BAR -->
	  
		<!-- HAMBURGER MENU -->
		<div id="hamburger-menu">
			<div id="hamburger-menu-list-container">
				<ul id="hamburger-menu-list">
					<li class="noselect hamburger-menu-item" data-target-element="#about"><div class="hamburger-menu-item-icon"><i class="fa fa-lightbulb-o" aria-hidden="true"></i></div><span class="hamburger-menu-item-text">ABOUT</span></li>
					<li class="noselect hamburger-menu-item" data-target-element="#professional-projects"><div class="hamburger-menu-item-icon"><i class="fa fa-users" aria-hidden="true"></i></div><span class="hamburger-menu-item-text">PROFESSIONAL PROJECTS</span></li>
					<li class="noselect hamburger-menu-item" data-target-element="#personal-work"><div class="hamburger-menu-item-icon"><i class="fa fa-heart" aria-hidden="true"></i></div><span class="hamburger-menu-item-text">PERSONAL WORK</span></li>
					<a href="../HugoPetersCV.pdf" style="border: none; text-decoration: none;" target="_blank">
						<li class="noselect hamburger-menu-item"><div class="hamburger-menu-item-icon"><i class="fa fa-file-text" aria-hidden="true"></i></div><span class="hamburger-menu-item-text">RÉSUMÉ</span></li>
					</a>
					<li class="noselect hamburger-menu-item" data-target-element="#contact"><div class="hamburger-menu-item-icon"><i class="fa fa-comments" aria-hidden="true"></i></div><span class="hamburger-menu-item-text">CONTACT</span></li>
				</ul>
			</div>
		</div>
		<!-- End of HAMBURGER MENU -->

		<!-- SOCIAL -> Page Cover -->
		<div id="social-pagecover-container">
			<!-- social-pagecover will be placed here dynamically -->
		</div>
		<!-- End of SOCIAL -> Page Cover -->
		
  <script type="text/javascript" src="../js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../js/bootstrap.js"></script>
<script type="text/javascript" src="../js/velocity.min.js"></script>
<script type="text/javascript" src="../js/velocity.ui.min.js"></script>
<script type="text/javascript" src="../js/jquery.vide.min.js"></script>
<script type="text/javascript" src="../js/help.parsecolor.js"></script>
<script type="text/javascript" src="../js/jquery.fullpage.min.html"></script>
<script type="text/javascript" src="../js/flickity.pkgd.min.js"></script>
<script type="text/javascript" src="../js/lity.min.js"></script>
<script type="text/javascript" src="../js/syntaxhighlighter/shCore.js"></script>
<script type="text/javascript" src="../js/syntaxhighlighter/shBrushCpp.js"></script>
<script type="text/javascript" src="../js/jquery.backstretch.min.js"></script>
<script type="text/javascript" src="../js/photoswipe.min.js"></script>
<script type="text/javascript" src="../js/photoswipe-ui-default.min.js"></script>
<script type="text/javascript" src="../js/plyr.js"></script>
<script type="text/javascript" src="../js/common.js"></script></body>

<!-- Mirrored from hugo.fyi/projects/reverse-engineering-b2s by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 20 Aug 2021 04:19:36 GMT -->
</html>


























